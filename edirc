#!/bin/bash
[[ -s ${rc="$HOME/.edirc"} && -r $rc ]] && source "$rc" || # disable rcfile: export rc=
{ read -r -p 'Nick: ' nick; read -r -p 'Host: ' host; read -r -p 'Port: ' port; }

exec 3<>"/dev/tcp/$host/$port" || { echo "Connection to $host failed" >&2 ; exit 1; }
printf 'NICK %s\n'  "$nick" >&3
printf 'USER %s %s * :%s\n' "${user:-"$nick"}" "${mode:-0}" "${realname:-"$nick"}" >&3

# fast way to enter commands directly  (and actually the only way to manage the bot)
mkfifo fifo && cat <> fifo >&3 &
# upload pastes
inotifywait --format %f -m . -e create 2> /dev/null |
while read -r; do
  if [[ $REPLY = paste:* ]]; then
    paste=$(curl -sF "aringa=<$REPLY" arin.ga)
    rm -f "$REPLY"
    REPLY=${REPLY#paste:} REPLY=${REPLY//,/\/}
    printf 'PRIVMSG %s :%s\n' "${REPLY:-Upload failed}" "$paste"
  fi
done >&3 &

shopt -s nullglob
trap 'rm -f ed:* paste:* fifo*; kill -TERM -$$' EXIT

# parse what we get from the server
while read -r raw; do
  raw=${raw%$'\r'}
  printf "%($timeformat)T %s\n" -1 "$raw" >> "log$host" # log everything here

  # most clients don't show trailing whitespace anyway
  read -r sender type target msg <<< "$raw"
  msg=${msg#:}

  if [[ $sender = PING ]]; then
    printf 'PONG %s\n' "$type" >&3
    continue
  fi

  if [[ $type = PRIVMSG ]]; then

    # in channels, ignore everything that doesn't start with ,
    # privately, everything is fine   (still remove a leading , for the sake of consistency)
    if [[ $msg = ,* || $target = "$nick" ]]; then
      # "/" is valid in chan names and will be replaced by "," which is not
      sender=${sender//\//,} sender=${sender#:} sender=${sender%%!*}
      [[ $target = "$nick" ]] && target=$sender

      # $REPLY is unquoted to match globs
      [[ -f spammers ]] && while read -r; do [[ $sender = $REPLY ]] && continue 2; done < spammers
      # would mapfile be faster?

      # if the file doesn't yet exist, ed is not running, start it
      # create a file for every user or channel
      if ! [[ -f ed:$target ]]; then
        > "ed:$target"
        mkfifo "fifo:$target"
        ./red "ed:$target" <> "fifo:$target" |& #fold -w 250 |   # fold sucks
        while read -r; do
          if (( SECONDS < 1 )); then (( row ++ ))
          else SECONDS=0 row=1
          fi
          if (( row < 3 )); then
            printf "PRIVMSG %s :%s\n" "$target" "$REPLY"
          elif (( row == 3 )); then
            printf "PRIVMSG %s :%s  /* max 3 lines/second */\n" "$target" "$REPLY"
          fi
        done >&3 &
      fi

      printf '%s\n' "${msg#,}" > "fifo:$target"
    fi
  fi
done <&3
